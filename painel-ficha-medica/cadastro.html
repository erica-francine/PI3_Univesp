<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Cadastro - Ficha Médica</title>
		<link rel="stylesheet" href="../css/cadastro.css">
		<link rel="stylesheet" href="../css/header.css">
		<header class="system-header">
			<div class="header-container">
				<!-- Logo -->
				<div class="logo-container">
					<a href="/" class="logo-link">
						<span class="logo-icon">🏥</span>
						<span class="logo-text">Sistema de Saúde</span>
					</a>
				</div>
				
				<!-- Menu Principal -->
				<nav class="main-nav">
					<ul class="nav-list">
						<li class="nav-item"><a href="/medicamentos" class="nav-link">💊 Medicamentos</a></li>
						<li class="nav-item"><a href="/exames" class="nav-link">🔬 Exames</a></li>
						<li class="nav-item"><a href="/cid10" class="nav-link">📋 CID-10</a></li>
						<li class="nav-item"><a href="/importar" class="nav-link">🔄 Importar Dados</a></li>
					</ul>
				</nav>
				
				<!-- Área do Usuário -->
				<div class="user-area" id="userArea">
					<div class="user-greeting" id="userGreeting"></div>
					<button class="auth-btn" id="authButton">🔑 Login</button>
				</div>
			</div>
		</header>
	</head>
	<body>
		<!-- Cabeçalho -->
		<div id="header-placeholder"></div>
		
		<div class="content-app">
			<div class="header">
				<h1>Sistema Ficha Médica Online</h1>
			</div>

			<!-- Seção de Medicamentos -->
			<div class="search-section">
				<h2><span class="section-icon">💊</span> Busca de Medicamentos</h2>
				<div class="search-container">
					<input type="text" id="medSearch" placeholder="Digite o nome do medicamento (mínimo 2 caracteres)...">
					<div id="medSuggestions" class="suggestions"></div>
				</div>
				<div id="medResults" class="results"></div>
				<div id="medList" class="results"></div>
			</div>

			<!-- Seção de Exames -->
			<div class="search-section">
				<h2><span class="section-icon">🔬</span> Busca de Exames</h2>
				<div class="search-container">
					<input type="text" id="examSearch" placeholder="Digite o nome do exame (mínimo 2 caracteres)...">
					<div id="examSuggestions" class="suggestions"></div>
				</div>
				<div id="examResults" class="results"></div>
				<div id="examList" class="results"></div>
			</div>

			<!-- Nova Seção de CID-10 -->
			<div class="search-section">
				<h2><span class="section-icon">🏥</span> Busca de CID-10</h2>
				<div class="search-container">
					<input type="text" id="cidSearch" placeholder="Digite código ou descrição CID-10 (mínimo 2 caracteres)...">
					<div id="cidSuggestions" class="suggestions"></div>
				</div>
				<div id="cidResults" class="results"></div>
				<div id="cidList" class="results"></div>
			</div>
		</div>

		<script>
			// Carrega o cabeçalho
			fetch('/components/header.html')
				.then(response => response.text())
				.then(html => {
					document.getElementById('header-placeholder').innerHTML = html;
					// Adiciona o script do cabeçalho
					const script = document.createElement('script');
					script.src = '../js/header.js';
					document.body.appendChild(script);
				});

			// Configurações comuns
			const config = {
				minChars: 2,
				debounceTime: 300
			};

			// Elementos de Medicamentos
			const medSearch = document.getElementById('medSearch');
			const medSuggestions = document.getElementById('medSuggestions');
			const medResults = document.getElementById('medResults');
			const medList = document.getElementById('medList');
			let medTimeout;

			// Elementos de Exames
			const examSearch = document.getElementById('examSearch');
			const examSuggestions = document.getElementById('examSuggestions');
			const examResults = document.getElementById('examResults');
			const examList = document.getElementById('examList');
			let examTimeout;

			// Elementos de CID-10
			const cidSearch = document.getElementById('cidSearch');
			const cidSuggestions = document.getElementById('cidSuggestions');
			const cidResults = document.getElementById('cidResults');
			const cidList = document.getElementById('cidList');
			let cidTimeout;

			// Eventos para Medicamentos
			medSearch.addEventListener('input', function () {
				clearTimeout(medTimeout);
				const term = this.value.trim();

				if (term.length === 0) {
					medSuggestions.style.display = 'none';
					medResults.innerHTML = ''; // Limpar resultados
					return;
				}

				if (term.length >= config.minChars) {
					medResults.innerHTML = '<div class="loading">Buscando medicamentos...</div>';
					medTimeout = setTimeout(() => {
							searchMedicamentos(term);
					}, config.debounceTime);
				}
			});

			// Eventos para Exames
			examSearch.addEventListener('input', function () {
				clearTimeout(examTimeout);
				const term = this.value.trim();

				if (term.length === 0) {
					examSuggestions.style.display = 'none';
					examResults.innerHTML = ''; // Limpar resultados
					return;
				}

				if (term.length >= config.minChars) {
					examResults.innerHTML = '<div class="loading">Buscando exames...</div>';
					examTimeout = setTimeout(() => {
							searchExames(term);
					}, config.debounceTime);
				}
			});

			// Eventos para CID-10
			cidSearch.addEventListener('input', function () {
				clearTimeout(cidTimeout);
				const term = this.value.trim();

				if (term.length === 0) {
					cidSuggestions.style.display = 'none';
					cidResults.innerHTML = ''; // Limpar resultados
					return;
				}

				if (term.length >= config.minChars) {
					cidResults.innerHTML = '<div class="loading">Buscando CID-10...</div>';
					cidTimeout = setTimeout(() => {
							searchCID10(term);
					}, config.debounceTime);
				}
			});

			// Função de busca para Medicamentos
			function searchMedicamentos(term) {
				fetch(`http://localhost:3000/medicamentos?s=${term}`)
					.then(response => response.json())
					.then(data => {
						showMedSuggestions(data);
						if (data.length === 0) {
								medResults.innerHTML = '<div class="no-results">Nenhum medicamento encontrado</div>';
						}
					})
					.catch(error => {
						console.error('Erro na busca de medicamentos:', error);
						medResults.innerHTML = '<div class="no-results">Erro ao buscar medicamentos</div>';
					});
			}

			// Função de busca para Exames
			function searchExames(term) {
				fetch(`http://localhost:3000/exames?s=${term}`)
					.then(response => response.json())
					.then(data => {
						showExamSuggestions(data);
						if (data.length === 0) {
								examResults.innerHTML = '<div class="no-results">Nenhum exame encontrado</div>';
						}
					})
					.catch(error => {
						console.error('Erro na busca de exames:', error);
						examResults.innerHTML = '<div class="no-results">Erro ao buscar exames</div>';
					});
			}

			// Função de busca para Cid10
			function searchCID10(term) {
				fetch(`http://localhost:3000/cid10?s=${term}`)
					.then(response => response.json())
					.then(data => {
						showCIDSuggestions(data);
						if (data.length === 0) {
								cidResults.innerHTML = '<div class="no-results">Nenhum código CID-10 encontrado</div>';
						}
					})
					.catch(error => {
						console.error('Erro na busca de CID-10:', error);
						cidResults.innerHTML = '<div class="no-results">Erro ao buscar CID-10</div>';
					});
			}

			// Mostrar sugestões para Medicamentos
			function showMedSuggestions(items) {
				medSuggestions.innerHTML = '';
				if (items.length === 0) {
					medSuggestions.style.display = 'none';
					return;
				}
				items.slice(0, 10).forEach(item => {
					const suggestion = document.createElement('div');
					suggestion.className = 'suggestion-item';
					const displayText = `${item.nomeProduto || 'Sem nome'} - ${(item.empresaDetentoraRegistro || 'Fabricante não informado').split('-')[1]} - ${item.situacaoRegistro || 'Sem status'}`;
					suggestion.textContent = displayText;
					suggestion.addEventListener('click', () => {
						medSearch.value = '';
						medSuggestions.style.display = 'none';
						addMedToList(item); // Adicionar à lista
					});
					medSuggestions.appendChild(suggestion);
				});
				medSuggestions.style.display = 'block';
			}

			// Mostrar sugestões para Exames
			function showExamSuggestions(items) {
				examSuggestions.innerHTML = '';
				if (items.length === 0) {
					examSuggestions.style.display = 'none';
					return;
				}
				items.slice(0, 10).forEach(item => {
					const suggestion = document.createElement('div');
					suggestion.className = 'suggestion-item';
					const displayText = `${item.nome || 'Sem nome'} - ${item.codigoTuss || 'Sem código'}`;
					suggestion.textContent = displayText;
					suggestion.addEventListener('click', () => {
						examSearch.value = '';
						examSuggestions.style.display = 'none';
						addExamToList(item); // Adicionar à lista
					});
					examSuggestions.appendChild(suggestion);
				});
				examSuggestions.style.display = 'block';
			}

			// Mostrar sugestões para CID-10
			function showCIDSuggestions(items) {
				cidSuggestions.innerHTML = '';
				if (items.length === 0) {
					cidSuggestions.style.display = 'none';
					return;
				}
				items.slice(0, 10).forEach(item => {
					const suggestion = document.createElement('div');
					suggestion.className = 'suggestion-item';
					const displayText = `${item.cid10 || 'Sem código'} - ${item.descricao || 'Sem descrição'}`;
					suggestion.textContent = displayText;
					suggestion.addEventListener('click', () => {
						cidSearch.value = '';
						cidSuggestions.style.display = 'none';
						addCIDToList(item); // Adicionar à lista
					});
					cidSuggestions.appendChild(suggestion);
				});
				cidSuggestions.style.display = 'block';
			}

			// Adicionar medicamento à lista com opção de remover
			function addMedToList(item) {
				const listItem = document.createElement('div');
				listItem.className = 'result-item';
				listItem.innerHTML = `
					<div class="result-item" style="position: relative;">
						<button class="remove-btn" title="Remover item" style="position: absolute; top: 10px; right: 10px;">🗑️</button>
						<div class="result-title">${item.tipoProduto} - ${item.nomeProduto || 'Sem nome'}</div>
						<div class="result-details">
							<strong>Status:</strong> ${item.situacaoRegistro}<br>
							<strong>Categoria:</strong> ${item.categoriaRegulatoria}<br>
							<strong>Empresa Detentora:</strong> ${(item.empresaDetentoraRegistro || 'Fabricante não informado').split('-')[1] || 'Não informado'}<br>
							<strong>Princípio Ativo:</strong> ${item.principioAtivo || 'Não informado'}<br>
							<strong>Registro:</strong> ${item.numeroRegistroProduto || 'Não informado'}<br>
							<strong>Classe Terapêutica:</strong> ${item.classeTerapeutica || 'Não informada'}
						</div>
					</div>
				`;
				medSuggestions.style.display = 'none';
				medResults.innerHTML = ''; // Limpar resultados
				listItem.querySelector('.remove-btn').addEventListener('click', () => {
					medList.removeChild(listItem);
				});
				medList.appendChild(listItem);
			}

			// Adicionar exame à lista com opção de remover
			function addExamToList(item) {
				const listItem = document.createElement('div');
				listItem.className = 'result-item';
				listItem.innerHTML = `
					<div class="result-item" style="position: relative;">
						<button class="remove-btn" title="Remover item" style="position: absolute; top: 10px; right: 10px;">🗑️</button>
						<div class="result-title">${item.nome || 'Sem nome'} - Código: ${item.codigoTuss || 'Não informado'}</div>
						<div class="result-details">
							<strong>Categoria:</strong> ${item.categoria || 'Não informada'}<br>
							<strong>Descrição:</strong> ${item.descricao || 'Não disponível'}
						</div>
					</div>
				`;
				examSuggestions.style.display = 'none';
				examResults.innerHTML = ''; // Limpar resultados
				listItem.querySelector('.remove-btn').addEventListener('click', () => {
					examList.removeChild(listItem);
				});
				examList.appendChild(listItem);
			}

			// Adicionar CID-10 à lista com opção de remover
			function addCIDToList(item) {
				const listItem = document.createElement('div');
				listItem.className = 'result-item';
				listItem.innerHTML = `
					<div class="result-item" style="position: relative;">
						<button class="remove-btn" title="Remover item" style="position: absolute; top: 10px; right: 10px;">🗑️</button>
						<div class="result-title">${item.cid10 || 'Sem código'} - ${item.descricao || 'Sem descrição'}</div>
						<div class="result-details">
							<strong>Código Completo:</strong> ${item.cid10 || 'Não informado'}<br>
							<strong>Descrição Completa:</strong> ${item.descricao || 'Não disponível'}
						</div>
					</div>
				`;
				cidSuggestions.style.display = 'none';
				cidResults.innerHTML = ''; // Limpar resultados
				listItem.querySelector('.remove-btn').addEventListener('click', () => {
						cidList.removeChild(listItem);
				});
				cidList.appendChild(listItem);
			}

			// Mostrar detalhes do Medicamento
			function showMedDetails(item) {
				let details = `
					<div class="result-item">
						<div class="result-title">${item.nomeComercial || 'Sem nome'} - ${item.fabricante || 'Fabricante não informado'}</div>
						<div class="result-details">
							<strong>Princípio Ativo:</strong> ${item.principioAtivo || 'Não informado'}<br>
							<strong>Registro Anvisa:</strong> ${item.registroAnvisa || 'Não informado'}<br>
							<strong>Classe Terapêutica:</strong> ${item.classeTerapeutica || 'Não informada'}
						</div>
					</div>
				`;
				medResults.innerHTML = details;
			}

			// Mostrar detalhes do Exame
			function showExamDetails(item) {
				let details = `
					<div class="result-item">
						<div class="result-title">${item.nome || 'Sem nome'} - Código: ${item.codigoTuss || 'Não informado'}</div>
						<div class="result-details">
							<strong>Categoria:</strong> ${item.categoria || 'Não informada'}<br>
							<strong>Descrição:</strong> ${item.descricao || 'Não disponível'}
						</div>
					</div>
				`;
				examResults.innerHTML = details;
			}

			// Mostrar detalhes do CID-10
			function showCIDDetails(item) {
				let details = `
					<div class="result-item">
						<div class="result-title">${item.cid10 || 'Sem código'} - ${item.descricao || 'Sem descrição'}</div>
						<div class="result-details">
							<strong>Código Completo:</strong> ${item.cid10 || 'Não informado'}<br>
							<strong>Descrição Completa:</strong> ${item.descricao || 'Não disponível'}
						</div>
					</div>
				`;
				cidResults.innerHTML = details;
			}

			// Fechar sugestões ao clicar fora
			document.addEventListener('click', function(e) {
				if (!e.target.closest('.suggestions') && !e.target.closest('input[type="text"]')) {
					medSuggestions.style.display = 'none';
					examSuggestions.style.display = 'none';
					cidSuggestions.style.display = 'none';
				}
			});
		</script>
	</body>
</html>
